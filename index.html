<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Inventario de Uniformes (Google Sheets)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .disabled-ui { pointer-events: none; opacity: 0.5; }
        .step-button {
            transition: all 0.2s ease-in-out;
        }
        .step-button.selected {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        .step-section[disabled] {
            opacity: 0.4;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center max-w-md mx-4">
            <h2 class="text-2xl font-bold mb-4">Acceso Requerido</h2>
            <p class="mb-6 text-gray-600">Para gestionar el inventario, necesitas autorizar la aplicación.</p>
            <button id="authorize-button" type="button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-colors w-full">
                Iniciar Sesión con Google
            </button>
             <div class="mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-md text-sm text-yellow-800">
                <p><strong>Paso de configuración:</strong></p>
                <p>Asegúrate de añadir la siguiente URL en "URIs de redireccionamiento autorizados" en Google Cloud:</p>
                <p id="redirect-uri-helper" class="font-mono bg-yellow-200 p-1 rounded mt-1 break-all"></p>
             </div>
             <p id="auth-error" class="text-red-500 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Gestor de Inventario</h1>
                <p class="text-gray-600 mt-1">Conectado a Google Sheets.</p>
            </div>
            <div>
                <button id="logout-button" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Cerrar Sesión
                </button>
            </div>
        </header>

        <!-- Pestañas y botón de refrescar -->
        <div class="flex justify-between items-center border-b border-gray-200 mb-6">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-inventario" class="px-3 py-2 font-medium text-sm rounded-t-lg border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 tab-active">
                    Inventario
                </button>
                <button id="tab-historial" class="px-3 py-2 font-medium text-sm rounded-t-lg border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Historial
                </button>
            </nav>
            <button id="refresh-button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors">
                Refrescar Datos
            </button>
        </div>

        <!-- Contenido Principal -->
        <main id="main-content" class="disabled-ui">
            <!-- Vista de Inventario -->
            <div id="view-inventario">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <!-- Indicador de Progreso / Breadcrumbs -->
                    <div id="breadcrumbs" class="mb-6 p-3 bg-gray-50 rounded-md text-gray-700 flex items-center justify-between">
                        <span id="breadcrumbs-text" class="text-sm md:text-base">Selecciona una categoría para empezar...</span>
                        <button id="reset-selection" class="hidden bg-gray-200 hover:bg-gray-300 text-xs font-bold py-1 px-3 rounded-full">Empezar de nuevo</button>
                    </div>

                    <!-- Asistente de Selección -->
                    <div id="selection-wizard" class="space-y-6">
                        <!-- Paso 1: Categoría -->
                        <div id="step-category" class="step-section">
                            <h3 class="font-semibold mb-2 text-lg">1. Categoría</h3>
                            <div id="options-category" class="flex flex-wrap gap-3"></div>
                        </div>
                        <!-- Paso 2: Prenda -->
                        <div id="step-garment" class="step-section" disabled>
                            <h3 class="font-semibold mb-2 text-lg">2. Prenda</h3>
                            <div id="options-garment" class="flex flex-wrap gap-3"></div>
                        </div>
                        <!-- Paso 3: Manga -->
                        <div id="step-sleeve" class="step-section" disabled>
                            <h3 class="font-semibold mb-2 text-lg">3. Manga</h3>
                            <div id="options-sleeve" class="flex flex-wrap gap-3"></div>
                        </div>
                        <!-- Paso 4: Talla -->
                        <div id="step-size" class="step-section" disabled>
                            <h3 class="font-semibold mb-2 text-lg">4. Talla</h3>
                            <div id="options-size" class="flex flex-wrap gap-3"></div>
                        </div>
                        <!-- Paso 5: Centro -->
                        <div id="step-center" class="step-section" disabled>
                            <h3 class="font-semibold mb-2 text-lg">5. Centro</h3>
                            <div id="options-center" class="flex flex-wrap gap-3"></div>
                        </div>
                    </div>
                    
                    <!-- Resultado Final -->
                    <div id="final-product-view" class="hidden mt-8 pt-6 border-t border-gray-200 fade-in">
                        <!-- La tarjeta del producto final se insertará aquí -->
                    </div>
                </div>
                 <div id="loading-indicator" class="text-center py-10 hidden"><p class="text-gray-500">Cargando...</p></div>
            </div>

            <!-- Vista de Historial -->
            <div id="view-historial" class="hidden fade-in">
                <h2 class="text-2xl font-bold mb-4">Historial de Movimientos</h2>
                <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Final</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Las filas del historial se insertarán aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 opacity-0"><p id="toast-message"></p></div>

    <script type="text/javascript">
        // --- CONFIGURACIÓN Y ESTADO ---
        const CLIENT_ID = '1084678415319-sabnfksn40aqvi85g34iapdoss71to1s.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1E-ouvUbArRjG9Wa5ghAy3uzo1sT5bXqjHZvPt4MP_nA';
        const INVENTORY_SHEET_NAME = 'Inventario';
        const HISTORY_SHEET_NAME = 'Historial';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        const COLS = { id: 0, categoria: 1, prenda: 2, manga: 3, talla: 4, centro: 5, stock: 6, imagen_url: 7 };

        let tokenClient;
        let allProducts = [];
        let selection = {
            category: null,
            garment: null,
            sleeve: null,
            size: null,
            center: null,
        };

        // --- LÓGICA DE AUTENTICACIÓN ---
        function gapiLoaded() { gapi.load('client', initializeGapiClient); }
        window.gapiLoaded = gapiLoaded;

        async function initializeGapiClient() {
            const authError = document.getElementById('auth-error');
            const authorizeButton = document.getElementById('authorize-button');

            try {
                // Paso 1: Comprobar si se ejecuta desde un servidor web
                if (window.location.protocol === 'file:') {
                    throw new Error("Esta aplicación debe ejecutarse desde un servidor web (usando una URL http:// o https://), no abriendo el archivo HTML directamente. El inicio de sesión no funcionará.");
                }
                document.getElementById('redirect-uri-helper').textContent = window.location.origin;

                // Paso 2: Inicializar el cliente de la API de Google
                await gapi.client.init({ discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });

                // Paso 3: Inicializar el cliente de autenticación
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthResponse
                });

                if (!tokenClient) {
                    throw new Error("El cliente de autenticación de Google no se pudo inicializar. Revisa que el CLIENT_ID sea correcto.");
                }

                // Paso 4: Asignar evento al botón y comprobar sesión existente
                authorizeButton.onclick = () => tokenClient.requestAccessToken({ prompt: 'consent' });
                document.getElementById('logout-button').onclick = handleSignoutClick;

                if (gapi.client.getToken() === null) {
                    document.getElementById('login-overlay').style.display = 'flex';
                } else {
                    handleAuthResponse({ access_token: gapi.client.getToken().access_token });
                }

            } catch (err) {
                console.error("Error crítico durante la inicialización de Google API:", err);
                authError.innerHTML = `<strong>Error de inicialización:</strong> ${err.message}`;
                authError.classList.remove('hidden');
                // Deshabilitar el botón si la inicialización falla
                authorizeButton.disabled = true;
                authorizeButton.textContent = 'Error de Configuración';
                authorizeButton.classList.add('bg-red-400', 'cursor-not-allowed');
            }
        }

        async function handleAuthResponse(resp) {
            if (resp.error || !resp.access_token) {
                document.getElementById('auth-error').textContent = `Error: ${resp.error || 'No se pudo autenticar'}.`;
                document.getElementById('auth-error').classList.remove('hidden');
                document.getElementById('login-overlay').style.display = 'flex';
                return;
            }
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('logout-button').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('disabled-ui');
            await loadSheetData();
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('logout-button').classList.add('hidden');
                document.getElementById('main-content').classList.add('disabled-ui');
                allProducts = [];
                resetSelection();
            }
        }

        // --- CARGA DE DATOS ---
        async function loadSheetData() {
            showToast('Cargando datos...');
            document.getElementById('loading-indicator').classList.remove('hidden');
            try {
                const inventoryPromise = gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID, range: `${INVENTORY_SHEET_NAME}!A2:H`,
                });
                const historyPromise = gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID, range: `${HISTORY_SHEET_NAME}!A2:E`,
                });

                const [inventoryResponse, historyResponse] = await Promise.all([inventoryPromise, historyPromise]);

                allProducts = (inventoryResponse.result.values || []).map((row, index) => ({
                    rowNum: index + 2, id: row[COLS.id], categoria: row[COLS.categoria], prenda: row[COLS.prenda],
                    manga: row[COLS.manga], talla: row[COLS.talla], centro: row[COLS.centro],
                    stock: parseInt(row[COLS.stock], 10) || 0, imageUrl: row[COLS.imagen_url] || ''
                }));
                
                const historyValues = (historyResponse.result.values || []).reverse();
                renderHistory(historyValues);
                
                resetSelection(); // Inicia el asistente
                showToast('Datos cargados.', 'success');
            } catch (err) {
                console.error('Error al cargar los datos:', err);
                showToast('Error al cargar los datos.', 'error');
            } finally {
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }

        // --- LÓGICA DEL ASISTENTE DE SELECCIÓN ---
        function resetSelection() {
            selection = { category: null, garment: null, sleeve: null, size: null, center: null };
            renderWizard();
            document.getElementById('reset-selection').classList.add('hidden');
        }

        function renderWizard() {
            updateBreadcrumbs();
            document.getElementById('final-product-view').classList.add('hidden');

            let filtered = allProducts;
            if (selection.category) filtered = filtered.filter(p => p.categoria === selection.category);
            if (selection.garment) filtered = filtered.filter(p => p.prenda === selection.garment);
            if (selection.sleeve) filtered = filtered.filter(p => p.manga === selection.sleeve);
            if (selection.size) filtered = filtered.filter(p => p.talla === selection.size);
            if (selection.center) filtered = filtered.filter(p => p.centro === selection.center);

            populateStep('category', [...new Set(allProducts.map(p => p.categoria))]);
            populateStep('garment', [...new Set(filtered.map(p => p.prenda))], !selection.category);
            populateStep('sleeve', [...new Set(filtered.map(p => p.manga))], !selection.garment);
            populateStep('size', [...new Set(filtered.map(p => p.talla))].sort((a, b) => a.localeCompare(b, undefined, { numeric: true })) , !selection.sleeve);
            populateStep('center', [...new Set(filtered.map(p => p.centro))], !selection.size);
            
            if (filtered.length === 1 && selection.center) {
                renderFinalProduct(filtered[0]);
            }
        }

        function populateStep(stepName, options, disabled = false) {
            const container = document.getElementById(`options-${stepName}`);
            const stepSection = document.getElementById(`step-${stepName}`);
            container.innerHTML = '';
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'step-button bg-white hover:bg-gray-100 border border-gray-300 text-gray-700 py-2 px-4 rounded-md';
                if (selection[stepName] === option) {
                    button.classList.add('selected');
                }
                button.onclick = () => handleStepSelection(stepName, option);
                container.appendChild(button);
            });
            
            disabled ? stepSection.setAttribute('disabled', '') : stepSection.removeAttribute('disabled');
        }

        function handleStepSelection(stepName, value) {
            if (selection[stepName] === value) {
                value = null;
            }
            selection[stepName] = value;
            
            const steps = ['category', 'garment', 'sleeve', 'size', 'center'];
            const currentStepIndex = steps.indexOf(stepName);
            for (let i = currentStepIndex + 1; i < steps.length; i++) {
                selection[steps[i]] = null;
            }
            
            document.getElementById('reset-selection').classList.remove('hidden');
            renderWizard();
        }

        function updateBreadcrumbs() {
            const text = Object.values(selection).filter(Boolean).join(' > ') || 'Selecciona una categoría para empezar...';
            document.getElementById('breadcrumbs-text').textContent = text;
        }

        function renderFinalProduct(product) {
            const container = document.getElementById('final-product-view');
            container.classList.remove('hidden');
            const stockColor = product.stock <= 10 ? 'text-red-600' : (product.stock <= 25 ? 'text-yellow-600' : 'text-green-600');
            const placeholderUrl = `https://placehold.co/200x200/e2e8f0/cbd5e0?text=${encodeURIComponent(product.prenda)}`;

            container.innerHTML = `
                <h3 class="text-xl font-bold mb-4">Producto Seleccionado</h3>
                <div class="bg-white rounded-lg shadow-lg p-6 flex flex-col md:flex-row items-center gap-6">
                    <img src="${product.imageUrl}" onerror="this.onerror=null;this.src='${placeholderUrl}';" alt="[Imagen de ${product.prenda}]" class="w-32 h-32 object-cover rounded-lg">
                    <div class="flex-1">
                        <h4 class="font-bold text-2xl">${product.prenda}</h4>
                        <p class="text-gray-600">Talla: ${product.talla} | Manga: ${product.manga} | Centro: ${product.centro}</p>
                        <p class="mt-2 font-bold text-3xl ${stockColor}">${product.stock} <span class="text-lg font-normal text-gray-500">en stock</span></p>
                    </div>
                    <div class="mt-4 md:mt-0 pt-4 md:pt-0 border-t md:border-t-0 md:border-l border-gray-200 md:pl-6 flex items-center gap-2">
                        <input type="number" value="1" min="1" class="w-20 text-center border-gray-300 rounded-md shadow-sm text-lg p-2">
                        <div class="flex flex-col gap-2">
                            <button data-id="${product.id}" data-action="sell" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition-colors">- Venta</button>
                            <button data-id="${product.id}" data-action="add" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition-colors">+ Entrada</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- ACTUALIZACIÓN DE STOCK Y OTROS ---
        async function updateStock(productId, action, quantity) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) { showToast('Producto no encontrado.', 'error'); return; }
            
            let newStock = product.stock;
            if (action === 'sell') {
                if (product.stock < quantity) { showToast('Stock insuficiente.', 'error'); return; }
                newStock -= quantity;
            } else {
                newStock += quantity;
            }

            showToast('Actualizando stock...');
            document.getElementById('main-content').classList.add('disabled-ui');

            try {
                const stockCell = `${INVENTORY_SHEET_NAME}!G${product.rowNum}`;
                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: stockCell, valueInputOption: 'USER_ENTERED', resource: { values: [[newStock]] } });
                const productName = `${product.prenda} Talla ${product.talla}, Centro ${product.centro}`;
                const historyRow = [new Date().toLocaleString('es-ES'), productName, action === 'sell' ? 'Venta' : 'Entrada', quantity, newStock];
                await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: `${HISTORY_SHEET_NAME}!A:E`, valueInputOption: 'USER_ENTERED', insertDataOption: 'INSERT_ROWS', resource: { values: [historyRow] } });
                
                showToast('Stock actualizado.', 'success');
                await loadSheetData(); // Esto recarga y resetea la vista
            } catch (err) {
                console.error('Error al actualizar:', err);
                showToast('Error al guardar.', 'error');
            } finally {
                document.getElementById('main-content').classList.remove('disabled-ui');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${type === 'error' ? 'bg-red-600' : 'bg-gray-900'}`;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        }
        
        function renderHistory(history) {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            if (!history || history.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-gray-500">No hay movimientos.</td></tr>`;
                 return;
            }
            history.forEach(row => {
                const typeClass = row[2] === 'Venta' ? 'text-red-500' : 'text-blue-500';
                tbody.innerHTML += `
                    <tr class="fade-in">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${row[0]}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${row[1]}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${typeClass}">${row[2]}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${row[3]}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800">${row[4]}</td>
                    </tr>`;
            });
        }

        // --- MANEJADORES DE EVENTOS ---
        function attachEventListeners() {
            document.getElementById('reset-selection').addEventListener('click', resetSelection);
            document.getElementById('refresh-button').addEventListener('click', loadSheetData);
            document.getElementById('final-product-view').addEventListener('click', (e) => {
                const target = e.target.closest('button[data-id]');
                if (!target) return;
                const quantity = parseInt(target.closest('.flex-col.gap-2').querySelector('input, .w-20'), 10);
                if (isNaN(quantity) || quantity <= 0) { showToast('Cantidad no válida.', 'error'); return; }
                updateStock(target.dataset.id, target.dataset.action, quantity);
            });
            document.querySelectorAll('[id^="tab-"]').forEach(tab => tab.addEventListener('click', (e) => {
                document.querySelectorAll('[id^="tab-"]').forEach(t => t.classList.remove('tab-active'));
                e.target.classList.add('tab-active');
                
                const isInventarioTab = e.target.id === 'tab-inventario';
                document.getElementById('view-inventario').style.display = isInventarioTab ? 'block' : 'none';
                document.getElementById('view-historial').style.display = isInventarioTab ? 'none' : 'block';
            }));
        }
        
        attachEventListeners();
    </script>
</body>
</html>
